
{% extends 'base.html' %}
{% block title %}Graficador de la Tierra del Sol y el Volc√°n{% endblock %}

{% block content %}
<style>
    /*
     * Estilos que GRITAN Nicaragua con Iconos de Guardabarranco y Escudo
     */
    :root {
        /* Paleta inspirada en la bandera nacional */
        --color-azul-bandera: #0067C6;       /* Azul cobalto de la bandera */
        --color-blanco-bandera: #FFFFFF;     /* Blanco puro del centro */
        --color-texto-oscuro: #333;          /* Texto oscuro para buena legibilidad */
        --color-sombra-profunda: rgba(0, 0, 0, 0.2);
    }

    body {
        /* Fondo con los colores de la bandera de Nicaragua */
        background: linear-gradient(to bottom, var(--color-azul-bandera) 0%, var(--color-azul-bandera) 25%, var(--color-blanco-bandera) 25%, var(--color-blanco-bandera) 75%, var(--color-azul-bandera) 75%, var(--color-azul-bandera) 100%);
        font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 0;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .graficador-container {
        width: 100%;
        max-width: 1000px;
        background: #F0F8FF; /* Blanco roto para contraste */
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 10px 30px var(--color-sombra-profunda);
        margin: 40px auto;
        position: relative;
        overflow: hidden;
    }

    .content-wrapper {
        position: relative;
        z-index: 1;
    }

    h2 {
        font-family: 'Poppins', sans-serif;
        font-weight: 700;
        font-size: 2.2rem;
        color: var(--color-azul-bandera);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
        margin-bottom: 10px;
        animation: slideInUp 0.6s ease-out;
        position: relative;
        z-index: 2;
    }

    .icon-volcano, .icon-sun, .icon-guardabarranco, .icon-escudo {
        font-size: 2.5rem;
        animation: pulse 2s infinite ease-in-out;
    }
    
    .icon-volcano {
        color: #C0392B; /* Rojo de la tierra */
    }

    .icon-sun {
        color: #F1C40F; /* Dorado del sol */
    }

    .icon-guardabarranco {
        color: #1ABC9C; /* Un verde-azulado vibrante para el guardabarranco */
        font-size: 2.3rem;
    }

    .icon-escudo {
        font-size: 2.5rem; /* Tama√±o similar al volc√°n/sol */
        color: #8E44AD; /* Un color p√∫rpura que puede evocar la idea de un arco√≠ris sutil */
    }
    
    p.descripcion {
        font-size: 1.1rem;
        color: var(--color-texto-oscuro);
        text-align: center;
        margin-bottom: 25px;
        animation: fadeIn 0.5s ease-out 0.2s backwards;
        position: relative;
        z-index: 1;
    }
    
    p.descripcion code {
        background-color: rgba(0, 103, 198, 0.1);
        color: var(--color-azul-bandera);
        padding: 4px 8px;
        border-radius: 8px;
        font-weight: bold;
    }

    .controls-container {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: center;
        margin-bottom: 25px;
        animation: fadeIn 0.5s ease-out 0.4s backwards;
        position: relative;
        z-index: 1;
    }

    #expr {
        flex-grow: 1;
        padding: 18px 25px;
        font-size: 1.1rem;
        font-family: 'Poppins', sans-serif;
        border-radius: 15px;
        border: 2px solid var(--color-blanco-bandera);
        background: #f0f0f0;
        box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1);
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }

    #expr:focus {
        outline: none;
        border-color: #F1C40F;
        box-shadow: 0 0 15px rgba(241, 196, 15, 0.4);
    }

    .btn {
        color: var(--color-blanco-bandera);
        text-decoration: none;
        padding: 15px 30px;
        border-radius: 15px;
        font-size: 1.1rem;
        font-weight: 600;
        border: none;
        cursor: pointer;
        box-shadow: 0 5px 20px var(--color-sombra-profunda);
        transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease;
    }
    
    .btn:hover {
        transform: translateY(-7px) scale(1.05);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
    }
    
    #addBtn {
        background: linear-gradient(45deg, #004D99, var(--color-azul-bandera));
    }

    #addBtn:hover {
        background: linear-gradient(45deg, var(--color-azul-bandera), #004D99);
    }
    
    #clearBtn {
        background: linear-gradient(45deg, #C0392B, #EB5757);
    }

    #clearBtn:hover {
        background: linear-gradient(45deg, #EB5757, #C0392B);
    }

    #jxgbox {
        width: 100% !important;
        height: 65vh !important;
        min-height: 500px !important;
        border-radius: 20px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        border: 2px solid var(--color-blanco-bandera);
        margin-top: 10px;
        animation: fadeIn 0.5s ease-out 0.6s backwards;
        position: relative;
        z-index: 1;
    }
    
    /* Animaciones que dan vida */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes slideInUp {
        from { opacity: 0; transform: translateY(50px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
</style>

<div class="graficador-container">
    <div class="content-wrapper">
        <h2>
            <span class="icon-guardabarranco">ü¶ú</span>
            <span class="icon-volcano">üåã</span>
            Graficador
            <span class="icon-sun">‚òÄÔ∏è</span>
            <span class="icon-escudo">‚õ∞Ô∏è</span>
        </h2>
        <p class="descripcion">
            ¬°Explora las matem√°ticas! Escribe expresiones como <code>f(x)=sin(x)</code>, <code>g(x)=x^2</code>, o <code>Circle([0,0],5)</code> y pulsa "A√±adir".
        </p>
        
        <div class="controls-container">
            <input id="expr" type="text" size="60" placeholder="Ej: f(x)=cos(x) o x^2+y^2=25">
            <button id="addBtn" class="btn">A√±adir</button>
            <button id="clearBtn" class="btn">Limpiar</button>
        </div>
        
        <div id="jxgbox" class="jxgbox"></div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jsxgraph/1.4.3/jsxgraphcore.js"></script>
<script>
    // Usar 'let' para poder reasignar la variable 'board' al limpiar
    let board = JXG.JSXGraph.initBoard('jxgbox', {boundingbox:[-10,10,10,-10], axis:true, showCopyright: false});

    /**
     * Funci√≥n auxiliar para limpiar la expresi√≥n y anteponer 'Math.' a las funciones.
     * Esto evita los errores de 'with(Math){...}' en el constructor Function.
     */
    function sanitizeExpression(expression) {
        // 1. Reemplaza el operador de potencia '^' por '**'
        let cleanExpr = expression.replace(/\^/g, '**');

        // 2. Lista de funciones matem√°ticas comunes
        const mathFunctions = ['sin', 'cos', 'tan', 'asin', 'acos', 'atan', 'sqrt', 'log', 'exp', 'abs', 'round', 'ceil', 'floor'];

        // 3. Reemplaza 'func(' con 'Math.func(' para todas las funciones en la lista
        mathFunctions.forEach(func => {
            // Usa una expresi√≥n regular para encontrar 'func(' solo si no est√° precedida por 'Math.'
            const regex = new RegExp(`(?<!Math\\.)\\b${func}\\(`, 'g');
            cleanExpr = cleanExpr.replace(regex, `Math.${func}(`);
        });
        
        // 4. Reemplaza pi y e por Math.PI y Math.E
        cleanExpr = cleanExpr.replace(/\b(pi|PI)\b/g, 'Math.PI');
        cleanExpr = cleanExpr.replace(/\b(e)\b/g, 'Math.E');

        return cleanExpr;
    }

    function addExpression(text){
        text = text.trim();
        if(!text) return;
        
        try {
            let exprToGraph;
            
            // 1. Intenta interpretar funciones de la forma f(x)=...
            let fnMatch = text.match(/^([a-zA-Z]\w*)\(x\)\s*=\s*(.+)$/);
            
            if(fnMatch){
                exprToGraph = fnMatch[2];
                const f = new Function('x', 'return ' + sanitizeExpression(exprToGraph));
                board.create('functiongraph', [f], {strokeColor:'#1f77b4', strokeWidth:3});
                return;
            }

            // 2. Intenta interpretar funciones de la forma y=...
            let yMatch = text.match(/^y\s*=\s*(.+)$/i);
            if(yMatch){
                exprToGraph = yMatch[1];
                const f = new Function('x', 'return ' + sanitizeExpression(exprToGraph));
                board.create('functiongraph', [f], {strokeColor:'#d62728', strokeWidth:3});
                return;
            }
            
            // 3. Intenta interpretar funciones directas (Ej: sin(x))
            if (!text.includes('=') && !text.toLowerCase().includes('circle') && !text.toLowerCase().includes('implicitcurve') && (text.includes('x') || text.match(/[0-9]+/))){
                exprToGraph = text;
                const f = new Function('x', 'return ' + sanitizeExpression(exprToGraph));
                board.create('functiongraph', [f], {strokeColor:'#ff7f0e', strokeWidth:3});
                return;
            }

            // 4. Intenta interpretar sintaxis Circle([cx,cy], r)
            let circ = text.match(/^Circle\s*\(\s*\[?\s*([-0-9.]+)\s*,\s*([-0-9.]+)\s*\]?\s*,\s*([-0-9.]+)\s*\)/i);
            if(circ){
                const cx = parseFloat(circ[1]), cy = parseFloat(circ[2]), r = parseFloat(circ[3]);
                board.create('circle', [[cx,cy], r], {strokeColor:'#2ca02c', strokeWidth:3});
                return;
            }

            // 5. Intenta interpretar c√≠rculos impl√≠citos (x^2+y^2=25)
            let implicitCircle = text.match(/^(x\^2|x\*\*2)\s*\+\s*(y\^2|y\*\*2)\s*=\s*([-0-9.]+)$/i);
            if(implicitCircle){
                const R = Math.sqrt(Math.abs(parseFloat(implicitCircle[3])));
                board.create('circle', [[0,0], R], {strokeColor:'#9467bd', strokeWidth:3});
                return;
            }
            
            // 6. Si no coincide con nada, intentar como curva impl√≠cita gen√©rica
            board.create('implicitcurve', [text.replace(/\^/g,'**')], {strokeColor:'#ff7f0e', strokeWidth:3});

        } catch (e) {
            console.error("Error al analizar la expresi√≥n:", e);
            alert('Expresi√≥n no reconocida o inv√°lida. Por favor, revisa la sintaxis.');
        }
    }

    document.getElementById('addBtn').addEventListener('click', function(){
        addExpression(document.getElementById('expr').value);
        document.getElementById('expr').value = ''; // Limpiar el input despu√©s de a√±adir
        document.getElementById('expr').focus(); // Devolver el foco al input
    });
    
    // Permitir a√±adir con la tecla Enter
    document.getElementById('expr').addEventListener('keyup', function(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            document.getElementById('addBtn').click();
        }
    });

    document.getElementById('clearBtn').addEventListener('click', function(){
        // 1. Destruye el tablero viejo
        JXG.JSXGraph.freeBoard(board);
        
        // 2. Crea un nuevo tablero y ASIGNA LA NUEVA INSTANCIA a la variable 'board'
        board = JXG.JSXGraph.initBoard('jxgbox', {boundingbox:[-10,10,10,-10], axis:true, showCopyright: false});
        
        // Opcional: limpiar la caja de texto y devolver el foco
        document.getElementById('expr').value = '';
        document.getElementById('expr').focus();
    });
</script>
{% endblock %}

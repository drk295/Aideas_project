
{% extends 'base.html' %}
{% block title %}Graficador de la Tierra del Sol y el Volc√°n{% endblock %}

{% block content %}
<style>
    /*
     * Estilos que GRITAN Nicaragua con Iconos de Guardabarranco y Escudo
     */
    :root {
        /* Paleta inspirada en la bandera nacional */
        --color-azul-bandera: #0067C6;       /* Azul cobalto de la bandera */
        --color-blanco-bandera: #FFFFFF;     /* Blanco puro del centro */
        --color-texto-oscuro: #333;          /* Texto oscuro para buena legibilidad */
        --color-sombra-profunda: rgba(0, 0, 0, 0.2);
    }

    body {
        /* Fondo con los colores de la bandera de Nicaragua */
        background: linear-gradient(to bottom, var(--color-azul-bandera) 0%, var(--color-azul-bandera) 25%, var(--color-blanco-bandera) 25%, var(--color-blanco-bandera) 75%, var(--color-azul-bandera) 75%, var(--color-azul-bandera) 100%);
        font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 0;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .graficador-container {
        width: 100%;
        max-width: 1000px;
        background: #F0F8FF; /* Blanco roto para contraste */
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 10px 30px var(--color-sombra-profunda);
        margin: 40px auto;
        position: relative;
        overflow: hidden;
        transition: box-shadow 0.3s ease; /* Transici√≥n para el efecto hover */
    }

    /* Efecto hover adicional para resaltar el contenedor */
    .graficador-container:hover {
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3), 0 0 50px rgba(241, 196, 15, 0.2);
    }

    .content-wrapper {
        position: relative;
        z-index: 1;
    }

    h2 {
        font-family: 'Poppins', sans-serif;
        font-weight: 700;
        font-size: 2.2rem;
        color: var(--color-azul-bandera);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
        margin-bottom: 10px;
        animation: slideInUp 0.6s ease-out;
        position: relative;
        z-index: 2;
        transition: color 0.3s ease;
    }
    
    /* Efecto hover de degradado de bandera en el t√≠tulo */
    h2:hover {
        background: linear-gradient(90deg, #0067C6, #FFFFFF, #F1C40F, #0067C6);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent; /* Hace que el color del texto sea transparente para ver el degradado */
        animation: none;
    }

    .icon-volcano, .icon-sun, .icon-guardabarranco, .icon-escudo {
        font-size: 2.5rem;
        animation: pulse 2s infinite ease-in-out;
    }
    
    .icon-volcano {
        color: #C0392B; /* Rojo de la tierra */
    }

    .icon-sun {
        color: #F1C40F; /* Dorado del sol */
    }

    .icon-guardabarranco {
        color: #1ABC9C; /* Un verde-azulado vibrante para el guardabarranco */
        font-size: 2.3rem;
    }

    .icon-escudo {
        font-size: 2.5rem; /* Tama√±o similar al volc√°n/sol */
        color: #8E44AD; /* Un color p√∫rpura que puede evocar la idea de un arco√≠ris sutil */
    }
    
    p.descripcion {
        font-size: 1.1rem;
        color: var(--color-texto-oscuro);
        text-align: center;
        margin-bottom: 25px;
        animation: fadeIn 0.5s ease-out 0.2s backwards;
        position: relative;
        z-index: 1;
    }
    
    p.descripcion code {
        background-color: rgba(0, 103, 198, 0.1);
        color: var(--color-azul-bandera);
        padding: 4px 8px;
        border-radius: 8px;
        font-weight: bold;
    }

    .controls-container {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: center;
        margin-bottom: 25px;
        animation: fadeIn 0.5s ease-out 0.4s backwards;
        position: relative;
        z-index: 1;
    }

    #expr {
        flex-grow: 1;
        padding: 18px 25px;
        font-size: 1.1rem;
        font-family: 'Poppins', sans-serif;
        border-radius: 15px;
        border: 2px solid var(--color-blanco-bandera);
        background: #f0f0f0;
        box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1);
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }

    #expr:focus {
        outline: none;
        border-color: #F1C40F;
        box-shadow: 0 0 15px rgba(241, 196, 15, 0.4);
    }

    .btn {
        color: var(--color-blanco-bandera);
        text-decoration: none;
        padding: 15px 30px;
        border-radius: 15px;
        font-size: 1.1rem;
        font-weight: 600;
        border: none;
        cursor: pointer;
        box-shadow: 0 5px 20px var(--color-sombra-profunda);
        transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease;
    }
    
    .btn:hover {
        transform: translateY(-7px) scale(1.05);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
    }
    
    #addBtn {
        background: linear-gradient(45deg, #004D99, var(--color-azul-bandera));
    }

    #addBtn:hover {
        background: linear-gradient(45deg, var(--color-azul-bandera), #004D99);
    }
    
    #clearBtn {
        background: linear-gradient(45deg, #C0392B, #EB5757);
    }

    #clearBtn:hover {
        background: linear-gradient(45deg, #EB5757, #C0392B);
    }

    #jxgbox {
        width: 100% !important;
        height: 65vh !important;
        min-height: 500px !important;
        border-radius: 20px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        border: 2px solid var(--color-blanco-bandera);
        margin-top: 10px;
        animation: fadeIn 0.5s ease-out 0.6s backwards;
        position: relative;
        z-index: 1;
    }
    
    /* Animaciones que dan vida */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes slideInUp {
        from { opacity: 0; transform: translateY(50px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
</style>

<div class="graficador-container">
    <div class="content-wrapper">
        <h2>
            <span class="icon-guardabarranco">ü¶ú</span>
            <span class="icon-volcano">üåã</span>
            Graficador
            <span class="icon-sun">‚òÄÔ∏è</span>
            <span class="icon-escudo">‚õ∞Ô∏è</span>
        </h2>
        <p class="descripcion">
            ¬°Explora las matem√°ticas! Escribe expresiones como <code>y=2x</code>, <code>f(x)=3cos(x)</code>, o <code>Circle([0,0],5)</code> y pulsa "A√±adir".
        </p>
        
        <div class="controls-container">
            <input id="expr" type="text" size="60" placeholder="Ej: f(x)=cos(x) o x^2+y^2=25">
            <button id="addBtn" class="btn">A√±adir</button>
            <button id="clearBtn" class="btn">Limpiar</button>
        </div>
        
        <div id="jxgbox" class="jxgbox"></div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jsxgraph/1.4.3/jsxgraphcore.js"></script>
<script>
    // Usar 'let' para poder reasignar la variable 'board' al limpiar
    let board = JXG.JSXGraph.initBoard('jxgbox', {
        boundingbox: [-10, 10, 10, -10],
        axis: true,
        showCopyright: false,
        keepaspectratio: true // Mantiene c√≠rculos redondos
    });

    // Control de colores para las gr√°ficas
    let graphCount = 0;
    const colors = ['#1f77b4', '#d62728', '#2ca02c', '#ff7f0e', '#9467bd', '#8c564b'];

    /**
     * Funci√≥n principal para sanitizar y preparar la expresi√≥n para JS.
     * Incluye:
     * 1. Multiplicaci√≥n impl√≠cita (Ej: 2x -> 2*x, 3sin(x) -> 3*Math.sin(x))
     * 2. Reemplazo de ^ por **
     * 3. Anteponer Math. a funciones y constantes.
     */
    function sanitizeExpression(expression) {
        // 1. Reemplaza el operador de potencia '^' por '**'
        let cleanExpr = expression.replace(/\^/g, '**');

        // 2. Reemplaza pi y e por Math.PI y Math.E primero
        cleanExpr = cleanExpr.replace(/\b(pi|PI)\b/g, 'Math.PI');
        cleanExpr = cleanExpr.replace(/\b(e)\b/g, 'Math.E');

        // 3. Lista de funciones matem√°ticas comunes
        const mathFunctions = ['sin', 'cos', 'tan', 'asin', 'acos', 'atan', 'sqrt', 'log', 'exp', 'abs', 'round', 'ceil', 'floor', 'min', 'max'];

        // 4. Inserci√≥n de '*' para multiplicaci√≥n impl√≠cita: constante seguida de variable/funci√≥n.
        // Ej: 2x -> 2*x, 3sin(x) -> 3*sin(x), 2pi -> 2*pi
        cleanExpr = cleanExpr.replace(
            /([0-9\.]+)(?=([a-zA-Z\(]))/g,
            (match, p1) => p1 + '*'
        );
        
        // 5. Anteponer 'Math.' a las funciones
        mathFunctions.forEach(func => {
            // Busca 'func(' y lo reemplaza con 'Math.func('
            const regex = new RegExp(`(?<!Math\\.)\\b${func}\\(`, 'g');
            cleanExpr = cleanExpr.replace(regex, `Math.${func}(`);
        });
        
        return cleanExpr;
    }


    function addExpression(text) {
        text = text.trim();
        if (!text) return;

        // Determina el color para esta nueva gr√°fica y avanza el contador
        const currentColor = colors[graphCount % colors.length];
        graphCount++;

        try {
            let exprToGraph;
            // Sanitiza el texto de entrada UNA VEZ al principio
            let sanitizedText = sanitizeExpression(text);

            // 1. Intenta interpretar funciones de la forma f(x)=...
            let fnMatch = text.match(/^([a-zA-Z]\w*)\(x\)\s*=\s*(.+)$/);

            if (fnMatch) {
                exprToGraph = fnMatch[2];
                // Sanitizamos solo el lado derecho de la ecuaci√≥n
                const f = new Function('x', 'return ' + sanitizeExpression(exprToGraph));
                board.create('functiongraph', [f], {
                    strokeColor: currentColor,
                    strokeWidth: 3
                });
                return;
            }

            // 2. Intenta interpretar funciones de la forma y=...
            let yMatch = text.match(/^y\s*=\s*(.+)$/i);
            if (yMatch) {
                exprToGraph = yMatch[1];
                // Sanitizamos solo el lado derecho de la ecuaci√≥n
                const f = new Function('x', 'return ' + sanitizeExpression(exprToGraph));
                board.create('functiongraph', [f], {
                    strokeColor: currentColor,
                    strokeWidth: 3
                });
                return;
            }

            // 3. Intenta interpretar funciones directas (Ej: sin(x) o 3)
            if (!text.includes('=') && !text.toLowerCase().includes('circle') && (text.includes('x') || text.match(/^[0-9.]+$|^pi$|^e$/i))) {
                exprToGraph = text;
                const f = new Function('x', 'return ' + sanitizedText);
                board.create('functiongraph', [f], {
                    strokeColor: currentColor,
                    strokeWidth: 3
                });
                return;
            }

            // 4. Intenta interpretar sintaxis Circle/C√≠rculo ([cx,cy], r)
            let circ = text.match(/^(?:Circle|C√≠rculo)\s*\(\s*\[?\s*([-0-9.eE]+)\s*,\s*([-0-9.eE]+)\s*\]?\s*,\s*([-0-9.eE]+)\s*\)/i);
            if (circ) {
                const cx = parseFloat(circ[1]),
                    cy = parseFloat(circ[2]),
                    r = parseFloat(circ[3]);
                if (r <= 0) throw new Error("El radio debe ser positivo.");
                board.create('circle', [
                    [cx, cy], r
                ], {
                    strokeColor: currentColor,
                    strokeWidth: 3
                });
                return;
            }

            // 5. Curvas impl√≠citas gen√©ricas (e.g., x^2+y^2=25, x*y=1, etc.)
            if (text.includes('x') && text.includes('y') && text.includes('=')) {
                board.create('implicitcurve', [sanitizedText], {
                    strokeColor: currentColor,
                    strokeWidth: 3
                });
                return;
            }

            // Fallback: Si no coincide con ninguna forma, lanzar un error
            throw new Error("Formato de expresi√≥n no reconocido.");

        } catch (e) {
            console.error("Error al analizar la expresi√≥n:", e);
            // Mostrar una alerta con el mensaje de error para el usuario
            alert(`¬°Error, pinolero! No pude graficar la expresi√≥n.\n\nRevisa la sintaxis. Ejemplos v√°lidos:\n- f(x)=2x\n- y=3sin(x)\n- x^2+y^2=25\n- Circle([1, -2], 4)`);
        }
    }

    document.getElementById('addBtn').addEventListener('click', function() {
        addExpression(document.getElementById('expr').value);
        document.getElementById('expr').value = ''; // Limpiar el input despu√©s de a√±adir
        document.getElementById('expr').focus(); // Devolver el foco al input
    });

    // Permitir a√±adir con la tecla Enter
    document.getElementById('expr').addEventListener('keyup', function(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            document.getElementById('addBtn').click();
        }
    });

    document.getElementById('clearBtn').addEventListener('click', function() {
        // 1. Destruye el tablero viejo
        JXG.JSXGraph.freeBoard(board);

        // 2. Crea un nuevo tablero y ASIGNA LA NUEVA INSTANCIA a la variable 'board'
        board = JXG.JSXGraph.initBoard('jxgbox', {
            boundingbox: [-10, 10, 10, -10],
            axis: true,
            showCopyright: false,
            keepaspectratio: true
        });

        // 3. Reinicia el contador de colores
        graphCount = 0;

        // Opcional: limpiar la caja de texto y devolver el foco
        document.getElementById('expr').value = '';
        document.getElementById('expr').focus();
    });
</script>
{% endblock %}